<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQZ + BPV Trading Chart</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 sm:p-6">

    <div id="app" class="max-w-7xl mx-auto bg-gray-800 shadow-2xl rounded-xl p-4 sm:p-6">
        <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-6">
            <h1 id="chart-title" class="text-2xl font-bold text-gray-100">
                Loading Symbol...
            </h1>
            <div class="flex items-center gap-4">
                <div id="status-indicator" class="flex items-center p-2 rounded-full text-sm font-semibold transition duration-300 bg-gray-700 text-gray-300">
                    <div class="w-2 h-2 rounded-full bg-yellow-500 mr-2 animate-pulse" id="status-dot"></div>
                    <span id="status-text">Initializing...</span>
                </div>
                <button id="copy-user-id" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-300">
                    Copy User ID
                </button>
            </div>
        </div>

        <!-- Chart Area -->
        <div class="relative h-[70vh] bg-gray-900 rounded-lg p-2 shadow-inner">
            <div id="trading-chart" class="w-full h-full"></div>
            <div id="loading-indicator" class="absolute inset-0 flex items-center justify-center bg-gray-900/80 text-gray-400 font-medium text-lg">
                <p>Loading chart data...</p>
            </div>
        </div>
    </div>

    <script>
        // --- Application State and Configuration ---
        let tradingChart = null;
        let chartData = { ohlc: [], bubbles: [] };
        let symbol = null;
        let userId = null;
        let db = null;
        let unsubscribe = null; // To hold the Firestore listener

        // --- Firebase Configuration (to be populated by a config script/env vars) ---
        const __app_id = 'bpv-sqz-app';
        const __firebase_config = {
            // This will be replaced by your actual Firebase config
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const __initial_auth_token = undefined;

        // --- UI & Status Helpers ---
        function updateStatus(state, message) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            dot.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-red-500', 'animate-pulse');
            switch (state) {
                case 'LOADING':
                    dot.classList.add('bg-yellow-500', 'animate-pulse');
                    break;
                case 'LIVE':
                    dot.classList.add('bg-green-500');
                    break;
                case 'ERROR':
                    dot.classList.add('bg-red-500');
                    break;
            }
            text.textContent = message;
        }

        function setChartTitle(symbol) {
            document.getElementById('chart-title').textContent = `SQZ + BPV Chart for ${symbol}`;
        }

        // --- Core Data Logic ---
        async function initializeApp() {
            // 1. Get symbol from URL
            const urlParams = new URLSearchParams(window.location.search);
            symbol = urlParams.get('symbol');
            if (!symbol) {
                updateStatus('ERROR', 'No symbol provided in URL.');
                document.getElementById('loading-indicator').textContent = 'Error: Please provide a symbol in the URL, e.g., ?symbol=NSE:RELIANCE';
                return;
            }
            setChartTitle(symbol);

            // 2. Initialize Firebase and Authenticate
            try {
                firebase.initializeApp(__firebase_config);
                db = firebase.firestore();
                const auth = firebase.auth();

                if (__initial_auth_token) {
                    const userCredential = await auth.signInWithCustomToken(__initial_auth_token);
                    userId = userCredential.user.uid;
                } else {
                    const userCredential = await auth.signInAnonymously();
                    userId = userCredential.user.uid;
                }
                updateStatus('LOADING', `Authenticated as ${userId.substring(0, 8)}...`);
                document.getElementById('copy-user-id').onclick = () => navigator.clipboard.writeText(userId);

            } catch (e) {
                updateStatus('ERROR', 'Firebase initialization failed.');
                console.error("Firebase init error:", e);
                return;
            }

            // 3. Start the data loading sequence
            await loadAndDisplayData();
        }

        async function loadAndDisplayData() {
            updateStatus('LOADING', 'Fetching historical data...');

            const todayStr = new Date().toISOString().slice(0, 10);
            const docId = `${symbol}_${todayStr}`;
            const docRef = db.collection("artifacts").doc(__app_id).collection("public/data/live_candles").doc(docId);

            // Fetch initial data once
            const initialDoc = await docRef.get();
            if (initialDoc.exists) {
                const data = initialDoc.data();
                processCandleData(data.candles || []);
            } else {
                console.log("No historical data for today. Waiting for live data.");
                // Here you would call the backend to fill missing data if needed.
                // For this example, we will just wait for live data.
            }

            // Hide loading indicator and draw initial chart
            document.getElementById('loading-indicator').classList.add('hidden');
            drawChart();

            // 4. Set up live listener
            listenForLiveUpdates(docRef);
        }

        function listenForLiveUpdates(docRef) {
            if (unsubscribe) unsubscribe(); // Detach any old listener

            unsubscribe = docRef.onSnapshot(doc => {
                if (doc.exists) {
                    updateStatus('LIVE', 'Receiving live data...');
                    const data = doc.data();
                    processCandleData(data.candles || []);
                    drawChart(); // Redraw with new data
                }
            }, error => {
                console.error("Firestore listener error:", error);
                updateStatus('ERROR', 'Connection to live data failed.');
            });
        }

        function processCandleData(candles) {
            // Sort candles just in case they are out of order
            candles.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            chartData.ohlc = candles.map(c => [
                new Date(c.timestamp).getTime(),
                c.open,
                c.close,
                c.low,
                c.high,
                c.volume
            ]);

            // Create bubbles for candles with significant volume (ltq)
            const avgVolume = candles.reduce((acc, c) => acc + c.volume, 0) / candles.length || 1;

            chartData.bubbles = candles.filter(c => c.ltq > 0).map(c => {
                return [
                    new Date(c.timestamp).getTime(),
                    c.close, // Position bubble at the close price of the candle
                    c.ltq, // The size of the bubble is based on LTQ
                    (c.volume / avgVolume) // Example of a simple "impact score"
                ];
            });
        }

        // --- Charting Logic (adapted from BubbleChartApp) ---
        function drawChart() {
            const chartDom = document.getElementById('trading-chart');
            if (!tradingChart) {
                tradingChart = echarts.init(chartDom, 'dark');
            }

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' }
                },
                legend: {
                    data: ['Candles', 'Big Player Volume (BPV)'],
                    textStyle: { color: '#ccc' }
                },
                grid: { left: '10%', right: '8%', bottom: '15%' },
                xAxis: {
                    type: 'time',
                    scale: true,
                    axisLine: { lineStyle: { color: '#8392A5' } },
                },
                yAxis: {
                    scale: true,
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    splitLine: { lineStyle: { color: '#2c3440' } }
                },
                dataZoom: [
                    { type: 'inside', start: 50, end: 100 },
                    { show: true, type: 'slider', top: '90%', start: 50, end: 100 }
                ],
                series: [
                    {
                        name: 'Candles',
                        type: 'candlestick',
                        data: chartData.ohlc,
                        itemStyle: {
                            color: '#00da3c',
                            color0: '#ec0000',
                            borderColor: '#00da3c',
                            borderColor0: '#ec0000'
                        }
                    },
                    {
                        name: 'Big Player Volume (BPV)',
                        type: 'scatter',
                        data: chartData.bubbles,
                        symbolSize: function (data) {
                            // Scale bubble size based on LTQ
                            return Math.sqrt(data[2]) * 2;
                        },
                        itemStyle: {
                            color: new echarts.graphic.RadialGradient(0.4, 0.3, 1, [
                                { offset: 0, color: 'rgb(251, 118, 123)' },
                                { offset: 1, color: 'rgb(204, 46, 72)' }
                            ]),
                             opacity: 0.7
                        }
                    }
                ]
            };
            tradingChart.setOption(option, true);
        }

        // --- Initializer ---
        window.onload = initializeApp;
        window.onresize = () => {
            if (tradingChart) tradingChart.resize();
        };

    </script>
</body>
</html>