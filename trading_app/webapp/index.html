<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQZ + BPV Trading Chart</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 sm:p-6">

    <div id="app" class="max-w-7xl mx-auto bg-gray-800 shadow-2xl rounded-xl p-4 sm:p-6">
        <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-6">
            <h1 id="chart-title" class="text-2xl font-bold text-gray-100">
                Loading Symbol...
            </h1>
            <div class="flex items-center gap-4">
                <div id="status-indicator" class="flex items-center p-2 rounded-full text-sm font-semibold transition duration-300 bg-gray-700 text-gray-300">
                    <div class="w-2 h-2 rounded-full bg-yellow-500 mr-2 animate-pulse" id="status-dot"></div>
                    <span id="status-text">Initializing...</span>
                </div>
            </div>
        </div>

        <!-- Chart Area -->
        <div class="relative h-[70vh] bg-gray-900 rounded-lg p-2 shadow-inner">
            <div id="trading-chart" class="w-full h-full"></div>
            <div id="loading-indicator" class="absolute inset-0 flex items-center justify-center bg-gray-900/80 text-gray-400 font-medium text-lg">
                <p>Loading chart data...</p>
            </div>
        </div>
    </div>

    <script>
        // --- Application State and Configuration ---
        let tradingChart = null;
        let chartData = { ohlc: [], bubbles: [] };
        let symbol = null;
        let webSocket = null;

        // --- UI & Status Helpers ---
        function updateStatus(state, message) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            dot.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-red-500', 'animate-pulse');
            switch (state) {
                case 'CONNECTING':
                    dot.classList.add('bg-yellow-500', 'animate-pulse');
                    break;
                case 'LIVE':
                    dot.classList.add('bg-green-500');
                    break;
                case 'ERROR':
                case 'CLOSED':
                    dot.classList.add('bg-red-500');
                    break;
            }
            text.textContent = message;
        }

        function setChartTitle(symbol) {
            document.getElementById('chart-title').textContent = `SQZ + BPV Chart for ${symbol}`;
        }

        // --- Core WebSocket and Data Logic ---
        function initializeApp() {
            // 1. Get symbol from URL
            const urlParams = new URLSearchParams(window.location.search);
            symbol = urlParams.get('symbol');
            if (!symbol) {
                updateStatus('ERROR', 'No symbol provided in URL.');
                document.getElementById('loading-indicator').textContent = 'Error: Please provide a symbol in the URL, e.g., ?symbol=NSE:RELIANCE';
                return;
            }
            setChartTitle(symbol);

            // 2. Initialize the chart and connect WebSocket
            document.getElementById('loading-indicator').classList.add('hidden');
            drawChart();
            connectWebSocket();
        }

        function connectWebSocket() {
            // Use wss for secure connections in production
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.hostname}:8765`;

            updateStatus('CONNECTING', `Connecting to ${wsUrl}...`);
            webSocket = new WebSocket(wsUrl);

            webSocket.onopen = () => {
                updateStatus('CONNECTING', 'Connection open. Subscribing to symbol...');
                // Subscribe to the symbol's data feed
                webSocket.send(JSON.stringify({ action: 'subscribe', symbol: symbol }));
            };

            webSocket.onmessage = (event) => {
                const message = JSON.parse(event.data);

                if (message.type === 'historical_data') {
                    updateStatus('LIVE', 'Historical data loaded. Waiting for live feed...');
                    console.log(`Received ${message.data.length} historical candles.`);
                    processCandleData(message.data, true); // `true` to replace existing data
                } else if (message.type === 'live_candle') {
                    updateStatus('LIVE', 'Receiving live data...');
                    processCandleData([message.data], false); // `false` to update/append
                }

                drawChart(); // Redraw chart with new data
            };

            webSocket.onclose = () => {
                updateStatus('CLOSED', 'Connection closed. Please refresh.');
                console.log('WebSocket connection closed.');
            };

            webSocket.onerror = (error) => {
                updateStatus('ERROR', 'WebSocket error.');
                console.error('WebSocket Error:', error);
            };
        }

        function processCandleData(candles, isHistorical = false) {
            if (isHistorical) {
                chartData.ohlc = []; // Clear previous data
            }

            candles.forEach(c => {
                const candleTimestamp = new Date(c.timestamp).getTime();
                // The backend sends data with keys: open, high, low, close, volume, timestamp
                const ohlc_data = [
                    candleTimestamp,
                    c.open,
                    c.high,
                    c.low,
                    c.close,
                    c.volume
                ];

                // Find if a candle with the same timestamp already exists
                const existingCandleIndex = chartData.ohlc.findIndex(d => d[0] === candleTimestamp);

                if (existingCandleIndex !== -1) {
                    // Update existing candle for live data
                    chartData.ohlc[existingCandleIndex] = ohlc_data;
                } else {
                    // Add new candle
                    chartData.ohlc.push(ohlc_data);
                }
            });

            // Sort data by timestamp to ensure correctness, especially after adding historical data
            chartData.ohlc.sort((a, b) => a[0] - b[0]);
        }


        // --- Charting Logic (adapted from BubbleChartApp) ---
        function drawChart() {
            const chartDom = document.getElementById('trading-chart');
            if (!tradingChart) {
                tradingChart = echarts.init(chartDom, 'dark');
            }

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' }
                },
                legend: {
                    data: ['Candles'],
                    textStyle: { color: '#ccc' }
                },
                grid: { left: '10%', right: '8%', bottom: '15%' },
                xAxis: {
                    type: 'time',
                    scale: true,
                    axisLine: { lineStyle: { color: '#8392A5' } },
                },
                yAxis: {
                    scale: true,
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    splitLine: { lineStyle: { color: '#2c3440' } }
                },
                dataZoom: [
                    { type: 'inside', start: 50, end: 100 },
                    { show: true, type: 'slider', top: '90%', start: 50, end: 100 }
                ],
                series: [
                    {
                        name: 'Candles',
                        type: 'candlestick',
                        data: chartData.ohlc,
                        itemStyle: {
                            color: '#00da3c',
                            color0: '#ec0000',
                            borderColor: '#00da3c',
                            borderColor0: '#ec0000'
                        }
                    }
                    // BPV Bubble series removed for simplicity, as backend data feed needs to be adapted
                ]
            };
            tradingChart.setOption(option, true);
        }

        // --- Initializer ---
        window.onload = initializeApp;
        window.onresize = () => {
            if (tradingChart) tradingChart.resize();
        };
    </script>
</body>
</html>